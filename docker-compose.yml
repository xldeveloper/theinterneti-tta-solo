# TTA-Solo Database Infrastructure
#
# Provides Dolt (versioned SQL) and Neo4j (graph + vector) for local development.
#
# Usage:
#   docker compose up -d          # Start services
#   docker compose down           # Stop services
#   docker compose down -v        # Stop and remove volumes (reset data)
#
# After starting, initialize Neo4j indexes (one-time):
#   docker exec tta-neo4j cypher-shell -u neo4j -p "${NEO4J_PASSWORD:-neo4jpass}" \
#     -f /var/lib/neo4j/import/init.cypher
#
# Ports:
#   - Dolt SQL:    3306 (MySQL protocol)
#   - Neo4j HTTP:  7474 (Browser UI)
#   - Neo4j Bolt:  7687 (Driver protocol)

services:
  dolt:
    image: dolthub/dolt-sql-server:latest
    container_name: tta-dolt
    ports:
      - "${DOLT_PORT:-3306}:3306"
    environment:
      DOLT_ROOT_PASSWORD: ${DOLT_PASSWORD:-doltpass}
    volumes:
      - dolt-data:/var/lib/dolt
      - ./scripts/init-dolt.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "--password=${DOLT_PASSWORD:-doltpass}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  neo4j:
    image: neo4j:5-community
    container_name: tta-neo4j
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-neo4jpass}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - ./scripts/init-neo4j.cypher:/var/lib/neo4j/import/init.cypher:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: unless-stopped

volumes:
  dolt-data:
    name: tta-dolt-data
  neo4j-data:
    name: tta-neo4j-data
  neo4j-logs:
    name: tta-neo4j-logs
